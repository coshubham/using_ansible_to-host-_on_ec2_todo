---
# tasks file for backend

- name: Install backend packages using npm install
  become: true
  command: npm install
  args:
    chdir: /opt/todo/todo-backend

- name: Install PM2 globally
  become: true
  npm:
    name: pm2
    global: true
    state: present

- name: Check if start.js is there
  stat:
    path: /opt/todo/todo-backend/start.js
  register: start_js

- name: Debugging start.js
  debug:
    msg: "start.js exists: {{ start_js.stat.exists }}"

- name: Start the backend application with PM2
  become: true
  command: pm2 start start.js --name backend
  args:
    chdir: /opt/todo/todo-backend
  when: start_js.stat.exists

- name: Save PM2 process list
  become: true
  command: pm2 save

- name: Set PM2 to start on boot (startup)
  become: true
  command: pm2 startup systemd

# Optional: Check PM2 list again
- name: Show PM2 process list
  become: true
  command: pm2 list
  register: pm2_list
  changed_when: false

- name: Debug PM2 list
  debug:
    var: pm2_list.stdout_lines
